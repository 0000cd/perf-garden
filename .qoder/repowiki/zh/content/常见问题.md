# 常见问题

<cite>
**Referenced Files in This Document**   
- [PerfGarden.py](file://PerfGarden.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [性能问题](#性能问题)
2. [匹配失败问题](#匹配失败问题)
3. [配置问题](#配置问题)
4. [依赖问题](#依赖问题)
5. [错误代码参考](#错误代码参考)
6. [诊断步骤](#诊断步骤)

## 性能问题

当用户遇到性能问题，如高CPU使用率时，主要原因通常是线程数设置过高。`PerfGarden.py` 中的 `gate_multi_thread` 函数负责多线程处理，其 `max_threads` 参数控制最大线程数。默认情况下，该值设置为 `os.cpu_count() or 4`，即使用CPU核心数或默认4个线程。

**优化建议**：
- **调整 max_threads**：在YAML配置文件中明确设置 `max_threads` 参数。例如，如果CPU核心数较多，但系统资源紧张，可以将其设置为一个较低的值（如4或8），以避免过度占用CPU资源。
- **减小图片尺寸**：根据 `README.md` 的建议，减小图片尺寸是提升处理速度最有效的方法之一。对于手机截屏，建议将宽度缩小至720像素，这能在保持识别质量的同时大幅提升性能。
- **合理使用智能间隔**：通过 `leap` 参数（默认为3）设置检查间隔，系统会每隔几张图片检查一次，发现目标后自动回溯。这能显著提升处理速度且不会漏检。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L660-L728)
- [README.md](file://README.md#L241-L259)

## 匹配失败问题

模板匹配不成功是常见问题，原因多样，需针对性排查。

**主要原因及调试技巧**：
- **光照变化**：`cattail` 函数使用灰度图进行匹配，对颜色变化不敏感，但对光照变化仍可能有影响。确保测试环境的光照条件稳定。
- **图像缩放**：模板图片的尺寸必须小于或等于待检测图片。`cattail` 函数在执行前会进行模板尺寸校验，若模板过大，会返回 `EC03` 错误。确保模板是从任务图片中直接裁剪得到，而非截图或从不同尺寸设备获取。
- **阈值设置不当**：`cattail` 的 `threshold` 参数（默认0.9）定义了匹配的可信度。值越高要求越严格。如果匹配失败，可尝试降低阈值（如0.8），但需注意这可能增加误匹配的风险。
- **裁剪区域（crop）**：使用 `crop` 参数可以聚焦于图片的特定区域（如底部按钮或顶部标题），排除无关背景干扰，从而提高匹配成功率。

**调试技巧**：
- **可视化匹配结果**：虽然代码本身不提供可视化功能，但用户可以通过在 `trails` 函数中添加 `cv2.imshow` 或将匹配结果保存为图片来查看匹配过程。
- **检查调试日志**：程序在运行时会输出详细的调试日志（如 `print(f"{img_file}: {result}")`），这些日志显示了每张图片的匹配状态、置信度和耗时，是诊断匹配问题的关键。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L14-L85)
- [PerfGarden.py](file://PerfGarden.py#L267-L381)
- [README.md](file://README.md#L64-L73)

## 配置问题

YAML配置文件是任务调度的核心，配置错误会导致任务无法执行。

**常见问题及解决方案**：
- **YAML文件解析错误**：确保YAML文件格式正确，使用正确的缩进（空格而非Tab），并用引号包裹包含特殊字符的路径。`gate_from_yaml` 函数使用 `yaml.safe_load` 解析文件，如果格式错误会抛出异常。
- **路径格式错误**：路径应使用正斜杠 `/` 或双反斜杠 `\\`，并用引号包裹。例如：`path: "C:/Users/.../samples"`。路径错误会导致 `os.path.normpath` 处理失败，进而无法找到文件。
- **任务序列逻辑错误**：任务按YAML文件中的顺序执行。如果前一个任务出错（返回非 "PASS" 状态）或图片用完，后续任务会被自动跳过。确保任务顺序合理，例如，`skip` 任务应放在可能消耗大量图片的任务之前。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L384-L474)
- [README.md](file://README.md#L35-L63)

## 依赖问题

项目依赖于 `opencv-python`、`numpy` 和 `pyyaml` 三个库。

**处理安装失败**：
- **使用pip安装**：根据 `README.md` 的快速开始指南，运行 `pip install opencv-python numpy pyyaml` 进行安装。
- **网络问题**：如果因网络问题导致安装失败，可尝试使用国内镜像源，例如：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple opencv-python numpy pyyaml`。
- **环境问题**：确保Python环境正常。对于 `opencv-python`，有时需要安装特定版本以兼容操作系统。可尝试 `pip install opencv-python-headless` 用于无头服务器环境。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L7-L10)
- [README.md](file://README.md#L10-L34)

## 错误代码参考

代码中定义了详细的错误码，用于快速定位问题。

| 错误码 | 含义 | 触发条件 |
| :--- | :--- | :--- |
| **EC01** | 参数错误 | 传递给检测函数的参数无效，例如 `cattail` 的 `threshold` 不在0~1范围内，或 `cactus` 的 `acceleration` 不是1、2、4。 |
| **EC02** | 读取图片失败 | `cattail`、`cactus` 或 `blover` 函数无法读取指定路径的图片文件，通常由文件路径错误或文件损坏引起。 |
| **EC03** | 模板图片比任务图片大 | `cattail` 函数在执行匹配前进行校验，若模板图片的尺寸大于待检测图片，则返回此错误。 |
| **EB01** | blover参数错误 | 传递给 `blover` 函数的 `threshold` 或 `crop` 参数类型或值不正确。 |
| **EB02** | blover读取图片失败 | `blover` 函数无法读取待检测图片，原因同 `EC02`。 |

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L14-L85)
- [PerfGarden.py](file://PerfGarden.py#L88-L187)
- [PerfGarden.py](file://PerfGarden.py#L192-L263)

## 诊断步骤

为了帮助用户快速定位和解决问题，建议按以下步骤操作。

**启用详细日志输出**：
- 程序默认已启用详细日志。`trails` 函数中的 `print(f"{img_file}: {result}")` 语句会输出每张图片的处理结果，包括状态码、是否匹配、置信度和耗时。这是诊断问题的第一手资料。

**使用调试模式**：
- 虽然代码没有显式的“调试模式”开关，但其设计本身就是高度可调试的。通过分析日志输出，可以清晰地看到任务的执行流程。
- **诊断流程**：
  1.  **检查日志开头**：确认 `gate_from_yaml` 是否成功读取了YAML文件和母文件夹路径。
  2.  **观察任务执行**：查看每个子文件夹的任务进展日志（如 `【进展】子文件夹 task_1: 任务 1 (cattail), 匹配 frame_00032.jpg, 状态 PASS, 耗时 0.41 秒`）。
  3.  **定位错误**：如果某个任务返回非 "PASS" 状态（如 "ERROR" 或 "UNFOUND"），根据其返回的错误码（如 `EC01`）和上下文日志进行判断。
  4.  **检查最终结果**：程序结束时会输出总耗时和结果文件路径。检查生成的CSV文件，确认结果是否符合预期。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L267-L381)
- [PerfGarden.py](file://PerfGarden.py#L477-L609)
- [README.md](file://README.md#L204-L240)