# 常见问题

<cite>
**本文档中引用的文件**  
- [PerfGarden.py](file://PerfGarden.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [模板匹配失败问题排查](#模板匹配失败问题排查)
2. [多线程环境下的资源竞争与内存问题](#多线程环境下的资源竞争与内存问题)
3. [霍夫圆检测参数调优](#霍夫圆检测参数调优)
4. [YAML语法错误调试](#yaml语法错误调试)
5. [大量图片处理速度优化](#大量图片处理速度优化)

## 模板匹配失败问题排查

模板匹配失败是使用perf-garden过程中最常见的问题，主要由以下原因导致：

**可能原因：**
- **图像分辨率不一致**：模板图片与目标图片的像素尺寸不匹配。模板匹配对图像大小非常敏感，不同设备或不同缩放比例的截图会导致匹配失败。
- **光照变化**：虽然系统使用灰度图处理，对颜色变化不敏感，但极端的光照变化（如过曝或过暗）会影响边缘特征，导致匹配置信度下降。
- **模板未对齐**：模板在目标图片中的位置发生偏移，或存在旋转、缩放等几何变换。
- **模板来源不当**：使用截图而非从任务图片中直接裁剪得到的模板，或从不同尺寸设备获取的模板。

**应对策略：**
- 确保模板图片是从任务图片中直接裁剪得到的，保持像素级一致。
- 使用`crop`参数裁剪图片相关区域，减少背景干扰。正值从底部向上裁剪，负值从顶部向下裁剪。
- 调整`threshold`阈值，cattail方法默认阈值为0.9，可根据实际情况适当降低（但通常准确匹配在0.9以上）。
- 检查模板尺寸，确保模板图片不比任务图片大，否则会返回EC03错误。

**错误日志示例：**
```
【进展】子文件夹 任务 (2): 任务 1 (cattail), 匹配 None, 状态 EC03, 耗时 0.01秒
```

**排查步骤：**
1. 检查错误代码：EC01（参数错误）、EC02（读取图片失败）、EC03（模板图片过大）。
2. 验证模板和目标图片路径是否正确。
3. 确认模板是从目标图片中裁剪而来，且尺寸匹配。
4. 使用`crop`参数缩小检测区域，提高匹配精度。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L13-L84)
- [README.md](file://README.md#L62-L75)

## 多线程环境下的资源竞争与内存问题

在多线程环境下处理大量图片时，可能会遇到资源竞争和内存溢出问题。

**可能原因：**
- **线程数过多**：`max_threads`设置过高，超出CPU核心数，导致线程上下文切换开销过大，占用过多内存。
- **CSV文件写入冲突**：多个线程同时尝试写入同一个CSV文件，可能导致权限错误或数据损坏。
- **内存累积**：大量图片同时加载到内存中进行处理，导致内存溢出。

**处理方式：**
- 合理设置`max_threads`参数，建议设置为CPU核心数或略高，避免过度并行。默认值为`os.cpu_count() or 4`。
- 使用线程锁（`threading.Lock()`）保护CSV文件写入操作，确保线程安全。
- 实现CSV写入重试机制，在发生`PermissionError`时进行递增等待重试，最多3次。
- 优化图片读取方式，使用`cv2.imdecode`和`np.fromfile`处理中文路径和大文件。

**错误日志示例：**
```
【警告】写入CSV时权限错误（尝试 1/3）: [WinError 32] 另一个程序正在使用此文件，进程无法访问。
```

**排查步骤：**
1. 检查`max_threads`设置是否合理。
2. 确认CSV文件未被其他程序（如Excel）打开。
3. 监控内存使用情况，必要时降低线程数。
4. 查看是否有多个进程同时处理同一输出目录。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L521-L583)
- [PerfGarden.py](file://PerfGarden.py#L362-L518)

## 霍夫圆检测参数调优

霍夫圆检测（blover方法）的准确性高度依赖于参数设置。

**关键参数说明：**
- `dp`: 图像分辨率与累加器分辨率之比，1:1保持原始分辨率，值越大检测越粗糙。
- `minDist`: 圆心间最小距离，防止重叠圆检测，需根据目标间距调整。
- `param1`: Canny边缘检测高阈值，值越大边缘检测要求越严格，建议50-150。
- `minRadius`/`maxRadius`: 目标圆的最小和最大半径，根据实际目标尺寸设置。
- `param2`: 圆心累加器阈值，值越小检测越宽松，假圆越多，建议10-50。

**调优技巧：**
- 先固定`minRadius`和`maxRadius`为合理范围，确保目标圆在范围内。
- 调整`param1`控制边缘检测强度，光照好的图片可提高值，复杂背景可降低值。
- 调整`param2`平衡检测灵敏度和误检率，值越小越容易检测到假圆。
- 使用`crop`参数聚焦圆所在的区域，减少计算量和干扰。

**错误日志示例：**
```
【进展】子文件夹 任务 (2): 任务 2 (blover), 匹配 frame_00042.jpg, 状态 PASS, 耗时 0.12秒
```

**排查步骤：**
1. 检查是否返回EB01（参数错误）或EB02（读取图片失败）。
2. 验证`minRadius`和`maxRadius`是否包含目标圆的实际半径。
3. 调整`param2`值，观察检测结果变化。
4. 使用`crop`参数缩小检测区域，提高检测速度和准确性。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L89-L160)
- [README.md](file://README.md#L76-L87)

## YAML语法错误调试

YAML配置文件解析失败是常见的配置问题。

**常见错误：**
- **路径格式错误**：未使用引号或使用了错误的斜杠（如使用反斜杠`\`而非正斜杠`/`）。
- **缩进错误**：YAML对缩进敏感，使用Tab而非空格，或缩进不一致。
- **数据类型错误**：数字、布尔值等未正确格式化。
- **编码问题**：文件未保存为UTF-8编码。

**调试方法：**
- 使用`yaml.safe_load()`进行安全加载，避免执行任意代码。
- 捕获`yaml.YAMLError`异常，获取详细的解析错误信息。
- 验证配置文件结构，确保`path`和任务配置正确。
- 检查任务类型计数和表头生成逻辑。

**错误日志示例：**
```
YAML配置中未指定母文件夹路径
```

**排查步骤：**
1. 检查YAML文件是否为有效的YAML格式。
2. 验证`path`字段是否存在且路径正确。
3. 确认缩进使用空格而非Tab。
4. 检查特殊字符是否用引号包围。
5. 确保文件保存为UTF-8编码。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L275-L359)
- [README.md](file://README.md#L35-L61)

## 大量图片处理速度优化

处理大量图片时，可通过多种策略优化速度。

**优化建议：**
- **合理设置leap间隔**：`leap`参数控制检查间隔，默认为3。设置较大的leap值可跳过大量图片，发现匹配后自动回溯检查，大幅提升速度。
- **调整线程数**：根据CPU核心数合理设置`max_threads`，充分利用多核优势，但避免过度并行导致资源竞争。
- **减小图片尺寸**：对于手机截屏，建议将宽度缩小至720像素，能在保持识别质量的同时大幅提升处理性能。
- **使用skip指令**：跳过已知的无用时间段，减少处理图片数量。
- **裁剪检测区域**：使用`crop`参数只处理相关区域，减少计算量。

**性能对比：**
根据实际测试，对于包含200多帧图片的5轮测试，使用cattail方法在多线程下只需1.74秒即可完成识别，而传统OCR识别方法则需要84.6秒，处理速度约快50倍。

**错误日志示例：**
```
🌾 所有任务完成！总用时: 0.67秒，Have A Nice Day~ 🌾🌾🌾🌾🌾🌾
```

**排查步骤：**
1. 监控处理耗时，识别性能瓶颈。
2. 调整`leap`值，平衡速度和精度。
3. 优化图片尺寸和质量。
4. 合理分配线程数，避免资源争用。
5. 使用`skip`和`crop`减少不必要的处理。

**Section sources**
- [PerfGarden.py](file://PerfGarden.py#L164-L272)
- [README.md](file://README.md#L227-L229)