# 配置文件详解

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [PerfGarden.py](file://PerfGarden.py)
</cite>

## 目录
1. [全局配置项](#全局配置项)  
2. [任务类型与专属参数](#任务类型与专属参数)  
   2.1 [cattail（模板匹配）](#cattail模板匹配)  
   2.2 [cactus（图像差异检测）](#cactus图像差异检测)  
   2.3 [blover（圆圈检测）](#blover圆圈检测)  
   2.4 [skip（跳过图片）](#skip跳过图片)  
3. [通用参数说明](#通用参数说明)  
4. [任务执行逻辑](#任务执行逻辑)  
5. [参数类型与默认值](#参数类型与默认值)  
6. [配置错误与调试建议](#配置错误与调试建议)

## 全局配置项

配置文件中的全局配置项用于定义整个任务的运行环境和资源分配。这些参数位于配置文件的最顶层，不隶属于任何具体任务。

- **path**：指定任务图片的总文件夹路径。该路径决定了程序处理的范围，同时也是最终生成的 CSV 报告文件的保存位置。路径应使用正斜杠 `/` 或双反斜杠 `\\`，并用引号包围，以避免因特殊字符或空格导致的解析错误。例如：`"C:/Users/Blind/Documents/samples"`。

- **max_threads**：设置程序运行时的最大并发线程数。此参数控制程序可以同时处理多少个子文件夹。较高的数值可以显著提升处理速度，但也会增加 CPU 和内存的占用。建议根据计算机的 CPU 核心数进行设置，通常设置为 CPU 核心数或略低。若未在配置中指定，程序将默认使用 `os.cpu_count()` 的值。

**Section sources**
- [README.md](file://README.md#L40-L41)
- [PerfGarden.py](file://PerfGarden.py#L384-L474)

## 任务类型与专属参数

配置文件的核心是任务序列，每个任务定义了一种图像检测方法及其具体参数。任务将按照在文件中出现的顺序依次执行。

### cattail（模板匹配）

`cattail` 任务使用模板匹配算法，在目标图片中查找与指定模板完全一致的区域。它适用于识别按钮、图标、标题等具有固定外观的静态元素。

- **template**：必填参数，指定模板图片的文件路径。该图片应从待检测的图片序列中直接裁剪获得，以确保尺寸和角度完全匹配。模板图片的尺寸必须小于或等于待检测的图片。
- **threshold**：匹配可信度阈值，取值范围为 0.0 到 1.0，默认值为 0.9。该值表示匹配成功的最低置信度，值越高要求越严格。通常，准确匹配的置信度应在 0.9 以上。
- **crop**：图像裁剪比例，取值范围为 -99 到 99，默认值为 0。正值表示从图片底部向上裁剪，保留底部指定百分比的区域，适用于识别底部元素；负值表示从顶部向下裁剪，保留顶部指定百分比的区域，适用于识别顶部元素。

**Section sources**
- [README.md](file://README.md#L44-L55)
- [PerfGarden.py](file://PerfGarden.py#L14-L85)

### cactus（图像差异检测）

`cactus` 任务通过计算两张图片之间的像素级差异来检测变化。其最大特点是简单易用，大多数情况下无需配置 `template` 参数。

- **threshold**：差异百分比阈值，取值范围为 0 到 100，默认值为 1.0。当两张图片的差异区域占比超过此阈值时，判定为检测成功。对于变化区域较大的场景（如页面加载动画），应适当提高此值。
- **enable_denoising**：布尔值，表示是否启用降噪处理，默认值为 `false`。启用后可以减少噪点干扰，但可能会降低检测的敏感度。
- **acceleration**：下采样加速倍数，可选值为 1、2 或 4，默认值为 2。值越大，处理速度越快，但精度越低。当处理大量图片且对精度要求不高时，可使用较高的加速倍数。

**Section sources**
- [README.md](file://README.md#L46-L47)
- [PerfGarden.py](file://PerfGarden.py#L88-L187)

### blover（圆圈检测）

`blover` 任务使用霍夫圆变换算法来检测图片中的圆形数量。它特别适用于识别加载动画、图标等圆形元素。

- **threshold**：期望检测到的圆圈数量，必须为正整数，默认值为 1。当检测到的圆圈数量大于或等于此阈值时，判定为匹配成功。
- **crop**：图像裁剪比例，取值范围为 -99 到 99，默认值为 0。其用法与 `cattail` 任务中的 `crop` 参数相同。

**Section sources**
- [README.md](file://README.md#L58-L61)
- [PerfGarden.py](file://PerfGarden.py#L192-L263)

### skip（跳过图片）

`skip` 任务用于跳过指定数量的图片，常用于跳过视频开头的无用片段或加载时间过长的过渡动画。

- **skip_count**：要跳过的图片数量，必须为正整数。执行此任务后，后续任务将从剩余图片的开头开始处理。

**Section sources**
- [README.md](file://README.md#L46-L46)
- [PerfGarden.py](file://PerfGarden.py#L477-L609)

## 通用参数说明

以下参数是通用的，可以在 `cattail`、`cactus` 和 `blover` 等任务中使用，以优化检测过程。

- **crop**：已在各任务专属参数中详细说明。
- **fade**：布尔值，表示检测模式。当 `fade` 为 `false` 时，程序在首次检测到目标时即返回结果，适用于检测“进入页面”等场景。当 `fade` 为 `true` 时，程序会等待目标出现后再消失才返回结果，适用于检测“离开页面”或“动画结束”等场景。
- **leap**：跳跃步长，正整数，默认值为 3。它表示程序每隔几张图片检查一次。例如，`leap: 2` 表示每两张图检查一次。当检测到匹配时，程序会自动回溯到匹配点附近，以逐张检查的方式精确定位。这可以大幅提升处理速度而不会漏检。

**Section sources**
- [README.md](file://README.md#L135-L154)
- [PerfGarden.py](file://PerfGarden.py#L267-L381)

## 任务执行逻辑

任务序列的执行遵循严格的顺序和状态管理逻辑。程序会从上到下依次执行每个任务。

1.  **顺序执行**：每个任务都作用于当前剩余的图片流。前一个任务处理完后，会将未处理的图片传递给下一个任务。
2.  **状态依赖**：如果某个任务执行失败（例如，未找到匹配或发生错误），程序将自动跳过所有后续任务，并继续处理下一个子文件夹。
3.  **图片消耗**：当一个任务成功匹配到图片时，该图片及之前的所有图片都会被消耗掉，后续任务将从匹配点之后的下一张图片开始处理。
4.  **cactus 特殊逻辑**：当 `cactus` 任务未指定 `template` 参数时，系统会自动将当前任务序列中剩余的第一张图片作为模板基准，与后续图片进行比较。

**Section sources**
- [README.md](file://README.md#L63-L65)
- [PerfGarden.py](file://PerfGarden.py#L477-L609)

## 参数类型与默认值

为便于用户快速参考，以下是所有参数的类型、有效范围和默认值的汇总。

| 参数 | 类型 | 有效范围 | 默认值 | 适用任务 |
| :--- | :--- | :--- | :--- | :--- |
| path | 字符串 | 有效文件路径 | 无 (必填) | 全局 |
| max_threads | 整数 | 正整数 | CPU 核心数 | 全局 |
| template | 字符串 | 有效文件路径 | 无 (cattail/blover 必填) | cattail, blover |
| threshold | 浮点数/整数 | cattail: 0.0-1.0<br>cactus: 0-100<br>blover: >0 | cattail: 0.9<br>cactus: 1.0<br>blover: 1 | cattail, cactus, blover |
| crop | 整数 | -99 到 99 | 0 | cattail, cactus, blover |
| fade | 布尔值 | true / false | false | cattail, cactus, blover |
| leap | 整数 | 正整数 | 3 | cattail, cactus, blover |
| enable_denoising | 布尔值 | true / false | false | cactus |
| acceleration | 整数 | 1, 2, 4 | 2 | cactus |
| skip_count | 整数 | 正整数 | 无 (必填) | skip |

**Section sources**
- [README.md](file://README.md#L75-L109)
- [PerfGarden.py](file://PerfGarden.py#L14-L263)

## 配置错误与调试建议

配置错误是导致任务失败的常见原因。以下是一些常见问题及其解决方案：

- **路径格式错误**：确保 `path` 和 `template` 参数使用了正确的路径分隔符（推荐使用 `/`）并用引号包围。Windows 系统下，避免使用单个反斜杠 `\`，应使用 `\\` 或 `/`。
- **阈值设置不当**：
  - `cattail` 匹配失败：最常见的原因是 `threshold` 设置过高。尝试将阈值降低到 0.7 或 0.8。同时，检查模板图片是否是从目标图片中直接裁剪的，截图或不同设备的图片会导致匹配失败。
  - `cactus` 无法检测变化：如果变化不明显，可能需要降低 `threshold` 值。反之，如果误报率高，可以适当提高阈值。
- **模板尺寸问题**：`cattail` 任务会报错 `EC03`，如果模板图片比待检测的图片大。请确保模板尺寸合适。
- **图片尺寸不匹配**：`cactus` 任务要求两张用于比较的图片尺寸必须完全相同。如果在执行 `crop` 操作后图片尺寸发生变化，可能导致 `EC03` 错误。

**Section sources**
- [README.md](file://README.md#L76-L76)
- [README.md](file://README.md#L88-L88)
- [README.md](file://README.md#L108-L108)
- [PerfGarden.py](file://PerfGarden.py#L14-L187)